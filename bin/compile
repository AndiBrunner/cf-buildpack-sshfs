#!/usr/bin/env ruby
require "open-uri"

$:.unshift File.expand_path("../../lib", __FILE__)
$stdout.sync = true

build_dir = ARGV[0]
cache_dir = ARGV[1]
pwd=Dir.pwd

#puts "-----build_dir----"
#puts "build_dir=#{build_dir}" 
#system("ls -al #{build_dir}")
#puts "-----cache_dir----"
#puts "cache_dir=#{cache_dir}" 
#system("ls -al #{cache_dir}")
#puts "-----pwd----"
#puts "pwd=#{Dir.pwd}"
#system("ls -al") 

if !Dir.exists?(cache_dir)	
	puts "-----ddddd-1 ----"
	Dir.mkdir(cache_dir) 
end

if !Dir.exists?("#{cache_dir}/fuse")
	puts "-----ddddd-2 ----"
	Dir.chdir(cache_dir) 
	#system("mkdir -p .profile.d")
	#system("echo export LD_LIBRARY_PATH=$HOME/app/fuse/lib:$LD_LIBRARY_PATH > #{cache_dir}/.profile.d/sshfs.sh")  
	#system("echo 'mkdir -p $HOME/.ssh' >> #{cache_dir}/.profile.d/sshfs.sh")
	#system("echo 'echo $SSHFS_KEY >> $HOME/.ssh/id_rsa' >> #{cache_dir}/.profile.d/sshfs.sh")
	#system("echo 'sshfs -o ServerAliveInterval=15 $SSHFS_RMT $SSHFS_MNT' >> #{cache_dir}/.profile.d/sshfs.sh")
	#system("echo 'sshfs -o ServerAliveInterval=15 $SSHFS_RMT $SSHFS_MNT' >> #{cache_dir}/fuse/start_sshfs")

	#download sshfs
	system("wget https://s3.amazonaws.com/accax/sshfs-fuse-2.4-64.tar.bz2")
	system("tar xjvf sshfs-fuse-2.4-64.tar.bz2")
	system("rm sshfs-fuse-2.4-64.tar.bz2")

	system("echo 'export LD_LIBRARY_PATH=$HOME/app/fuse/lib:$LD_LIBRARY_PATH' > #{cache_dir}/fuse/start_sshfs")  
	system("echo 'mkdir -p $HOME/.ssh' >> #{cache_dir}/fuse/start_sshfs")
	system("echo 'echo $SSHFS_KEY >> $HOME/.ssh/id_rsa' >> #{cache_dir}/fuse/start_sshfs")
	system("echo 'sleep 10' >> #{cache_dir}/fuse/start_sshfs")
end

system("cp -r #{cache_dir}/fuse #{build_dir}/")
#system("cp -r #{cache_dir}/.profile.d #{build_dir}/")

#home=ENV["HOME"]

#Dir.chdir("#{build_dir}")
#puts "$HOME=#{home}"
puts "-----build_dir----"
system("ls -al #{build_dir}")
puts "-----cache_dir----"
system("ls -al #{cache_dir}")
puts "-----fuse_dir----"
system("ls -al #{build_dir}/fuse")
system("ls -al #{cache_dir}/fuse")
system("cat #{cache_dir}/fuse/start_sshfs")